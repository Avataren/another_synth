#!/usr/bin/env node
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const repoRoot = path.resolve(__dirname, '..');
const rustPath = path.join(repoRoot, 'rust-wasm', 'src', 'traits', 'mod.rs');
const outPath = path.join(repoRoot, 'src', 'audio', 'types', 'generated', 'port-ids.ts');

const src = fs.readFileSync(rustPath, 'utf8');

const match = src.match(/fn from_u32[^{]+{[^]*?match value\s*{([^}]*)}/m);
if (!match) {
  console.error('Could not find from_u32 match arms in traits/mod.rs');
  process.exit(1);
}

const arms = [...match[1].matchAll(/(\d+)\s*=>\s*PortId::([A-Za-z0-9_]+)/g)];
if (arms.length === 0) {
  console.error('No PortId arms found in from_u32');
  process.exit(1);
}

const entries = arms.map(([, num, name]) => ({ num: Number(num), name }));
entries.sort((a, b) => a.num - b.num);

const header = `// GENERATED BY scripts/generate-port-ids.js - DO NOT EDIT.
// Source: rust-wasm/src/traits/mod.rs::PortId
`;

const enumBody = entries
  .map(({ name, num }) => `  ${name} = ${num},`)
  .join('\n');

const output = `${header}export enum PortId {
${enumBody}
}
`;

fs.mkdirSync(path.dirname(outPath), { recursive: true });
fs.writeFileSync(outPath, output, 'utf8');
console.log(`Wrote ${outPath}`);
